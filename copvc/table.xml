<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="COPVC-table.xml">
    <Require feature="idi"/>
    <Require feature="locked-domain" />
	<Require feature="dynamic-height"/>
	<Require feature="setprefs" />
  </ModulePrefs>
  <UserPref name="spreadsheet_key" default_value="" display_name="Spreadsheet key" required="true" />
  <Content type="html">
    <![CDATA[
    <script src="https://www.google.com/jsapi" type="text/javascript"></script>
    <script src="https://cdn.rawgit.com/josedrac/gsites/test-oauth/evolucionaDigital/js/environment.js" type="text/javascript"></script>
    <script src="https://cdn.rawgit.com/sopraux/gsites/v1.0/evolucionaDigital/js/jquery.min.js" type="text/javascript"></script>
	<script src="https://cdn.rawgit.com/sopraux/gsites/v1.0/evolucionaDigital/js/smartpaginator.js" type="text/javascript"></script>

    <style type="text/css">

        .container-table {
            width: 100%;
        }

        #tableHeader {
            margin-top: 10px;
        }

        .headerImg {
            margin-top: 10px;
            margin: 10px 3px 0;
        }

        .table__header-col {
			width: 8%;
            height: 85px;
			border: 1px solid #E5E5E5;
            border-left: 0;
			background-color: #F8F8F5;
        }
		.table__header-col:last-child {
			border-right: 0;
		}
		.table__header-col_large {
			width: 20%;
		}
		.table__header-col_small {
			width: 1%;
		}

		.table__header-text {
            margin-top: 5px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            color: #434a58;
        }

        .firstcol {
            width: 36% !important;
            border-left: 0;
        }

        .firstcol img {
            display: none;
        }

		.table__row {
			clear: both;
			font-size: 12px;
			width: 100%;
			border-bottom: 1px solid #E5E5E5;
			overflow: hidden;
		}

        .table__cell {
            color: #434a58;
			padding: 10px;
            border-bottom: 1px solid #E5E5E5;
            text-align: center;
        }
		.table__cell_implemented {
			background-color: lightgreen;
		}
		.table__cell_planified {
			background-color: lightblue;
		}
		.table__cell_executing {
			background-color: lightyellow;
		}

		.table__cell-text {
			line-height: 15px;
			vertical-align: middle;
			display: table-cell;
			text-align: left;
		}

        .rowTitle {
            clear: both;
            width: 100%;
            margin-top: 20px;
            font-weight: bold;
            font-size: 13px;
            color: #434a58;
            margin-bottom: 5px;
        }

        .rowTitle td{
            padding-top: 20px;
        }

        span.click {
            color: #0078d2;
            text-decoration: none;
            cursor: pointer;
        }

        .controls {
            text-align: right;
            max-width: 969px;
            padding: 0 10px 5px 0;
        }
    </style>

    <div class="table-container">
        <table id="initiatives_table" class="table" cellspacing="0">
            <thead id="initiatives_table_header" class="table__header">

            </thead>

            <tbody  id="initiatives_table_body" class="table__body">

            </tbody>
        </table>

		<div id='pagination' class="pagination" style='margin: auto;'></div>
    </div>

    <script type="text/javascript">
        var params = {
				globalSearch: {	},
				nameInitiative: {
					col: 'D'
				},
				description: {
					col: 'E'
				},
				goal: {
					col: 'B'
				},
				status: {
					col: 'H'
				},
				category: {
					col: 'C'
				},
				valueRelated: {
					col: 'F'
				}
			},
			tableCols = [
				{
					header: 'País',
					class: 'table__header-col_small',
					sheetIndex: 15
				},
				{
					header: 'Nombre',
					sheetIndex: 3
				},
				{
					header: 'Descripción',
					class: 'table__header-col_large',
					sheetIndex: 4
				},
				{
					header: 'Objetivo',
					sheetIndex: 1
				},
				{
					header: 'Categoría',
					sheetIndex: 2
				},
				{
					header: 'Estado',
					sheetIndex: 7
				},
				{
					header: 'Enlace al repositorio',
					sheetIndex: 8
				}
			],
			gadgetHelper = null,
			prefs = new _IG_Prefs();


		initFilterParams();
		loadVisualizationAPI();


	 	function loadVisualizationAPI() {
			google.load("visualization", "1", {"packages": ["table"]});
			google.setOnLoadCallback(sendQuery);
		}

        function pagination(elements) {
	        $('#pagination').smartpaginator({
		        totalrecords: elements,
		        recordsperpage: 4,
		        length: 4,
		        datacontainer: 'paginas',
		        dataelement: 'div.comboVideo',
		        initval: 0,
	        });
	     }

        function getQueryParameters() {
     		var filter 	= 'select * where C IS NOT NULL',
				cols 	= 'BCDEFGHIJPQRST'.split('');

     		if (isSearchDone()) {
				Object.keys(params).forEach(function(key) {
					var param = params[key];
					if (param.value) {
						if (key === 'globalSearch') {
							return cols.forEach(function(col) {
								filter += ' AND (lower('+ col +') contains lower("' + param.value + '"))';
							});
						}
						filter += ' AND (lower('+ param.col +') contains lower("' + param.value + '"))';
					}
                });
 			}
			return encodeURIComponent(filter);
     	}

        function sendQuery() {

            var queryUrl = 'https://spreadsheets.google.com/tq?key=' + getSpreadsheetKey() + '&sheet=Catálogo&tq=' + getQueryParameters(),
				query = new google.visualization.Query(queryUrl);

            query.send(handleQueryResponse);
			gadgetHelper = new google.visualization.GadgetHelper();

        }

        function handleQueryResponse(response) {
			data = response.getDataTable();
			if (data) {
				createHeader();
				createBody(data);
			}
        }

        function createBody(data) {
            var numberOfRows = data.getNumberOfRows(),
				html = '';

            for (var i = 0; i < numberOfRows; i++) {
                html += '<tr class="table__row">';

				tableCols.forEach(function(col) {
					var value = data.getValue(i, col.sheetIndex) || '-',
						cssClass = '';

					if (col.header === 'Enlace al repositorio' && value !== '-') {
						html +=	'<td class="table__cell"><a class="table__cell-text table__cell-text_link" href="'+ value +'">Enlace</a></td>';
						return;
					}
					if (col.header === 'Estado' && value) {
						cssClass = getStatusCssClass(value);
					}
					html +=	'<td class="table__cell '+ cssClass +'"><span class="table__cell-text">'+ value +'</span></td>';
				});

                html += '</tr>';
            }

			$('#initiatives_table_body').html(html);
        }

        function createHeader() {
            var html = '',
				classCss;

            tableCols.forEach(function(item, index) {
				classCss = item.class ? item.class : '';
                html += '<th class="table__header-col '+ classCss +'">' +
                    	'	<span class="table__header-text">'+ item.header +'</span>' +
                		'</th>';
            });

            $('#initiatives_table_header').html(html);
        }

		function getStatusCssClass(value) {
			if (value === 'Implementada / Implemented') { return 'table__cell_implemented' }
			if (value === 'Planificada / Planned') { return 'table__cell_planified' }
			if (value === 'En ejecución / In execution') { return 'table__cell_executing' }
			return '';
		}

		function getUrl() {
			return document.referrer;
			//return location.href;
		}

		function getSpreadsheetKey() {
	        return prefs.getString('spreadsheet_key');
		}

        function isSearchDone() {
            return getUrl().split("=").length >= 2;
        }

        function initFilterParams() {
            var urlParam,
                listParams = getUrl().split('?')[1].split('&');

            listParams.forEach(function(item) {
                urlParam = decodeURIComponent(item).split('+').join(' ').split('=');
				if (item.length > 1){
					params[ urlParam[0] ].value = urlParam[1];
				}
            });
        }

        function Go(destination) {
            window.open(destination,'_parent');
            return false;
        }

    </script>
    ]]>
  </Content>

</Module>
