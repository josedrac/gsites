<?xml version="1.0" encoding="UTF-8" ?>
<Module>
 	<ModulePrefs title="NB-test.xml">
    	<Require feature="idi"/>
	    <Require feature="locked-domain" />
		<Require feature="dynamic-height"/>
        <Require feature="setprefs" />
  	</ModulePrefs>
    <UserPref name="spreadsheetKey"  display_name="URL Spreadsheet" required="true" />

    <Content type="html" charset="UTF-8">
    <![CDATA[
    	<script src="https://www.google.com/jsapi" type="text/javascript"></script>

    	<div id="section" class="container">
    		Esto es un test!
    	</div>
        <!-- <button id="authorize-button" onclick=handleAuthClick>Authorize</button> -->

        <script>
            // NOTE: You must replace the client id on the following line.
            var clientId = '890384802796-6k5nag1u5pd1pu219s0341ceko4rd9ui.apps.googleusercontent.com';
            var scopes = 'https://spreadsheets.google.com/feeds';

            function init() {
              gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: true},handleAuthResult);
            }

            function handleAuthResult(authResult) {
              // var authorizeButton = document.getElementById('authorize-button');
              if (authResult && !authResult.error) {
                // authorizeButton.style.visibility = 'hidden';
                ejecutarQuery();
              } else {
                // authorizeButton.style.visibility = '';
                // authorizeButton.onclick = handleAuthClick;
              }
            }

            function handleAuthClick(event) {
              gapi.auth.authorize(
                  {client_id: clientId, scope: scopes, immediate: false},
                  handleAuthResult);
              return false;
            }
        </script>

        <script type="text/javascript">
            google.load('visualization', '1', {packages: ['table']});
        </script>

        <script type="text/javascript">
            function ejecutarQuery() {
                var prefs = new gadgets.Prefs(),
                    spreadsheetKey = prefs.getString('spreadsheetKey'),
                    sectionId = prefs.getString('sectionId'),
                    queryString = encodeURIComponent('SELECT *'),
                    query = new google.visualization.Query("https://docs.google.com/spreadsheets/d/1drprpJWppUaHhn8ViWA-0Q-cnwk6M5MD_sGpnvVn1q8/gviz/tq?sheet=Sheet1&headers=1&tq=" + queryString + "&access_token=" + encodeURIComponent(gapi.auth.getToken().access_token));
                    console.log(query);
                    query.send(handleQueryResponse);

                function handleQueryResponse(response) {
                    if (response.isError()) {
                        console.log('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                        return;
                    }
                    var dataTable = response.getDataTable();
					dataTable.getNumberOfRows() ? printDataTable(dataTable) : console.log('spreadsheet is empty');
                }

                function printDataTable(dataTable) {
					var index = hasAnotherDate(dataTable);

					var aux1 = dataTable.getValue(index, 1),
					    aux2 = dataTable.getValue(index, 2);

					var html = "";
					html += '<p>' + aux1 + '</p>';
					html += '<p>'+ aux2 +'</p>';

					document.getElementById("section").innerHTML = html;
				}
            }

        </script>

        <script src="https://apis.google.com/js/auth.js?onload=init"></script>
    ]]>
  	</Content>
</Module>
