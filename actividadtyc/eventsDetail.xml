<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="AC-eventsDetail.xml"
    description="">
    <Require feature="idi"/>
    <Require feature="locked-domain" />
	<Require feature="dynamic-height"/>
	<Require feature="setprefs" />
  </ModulePrefs>
	<UserPref name="spreadsheetKey" default_value="" display_name="Data source url (Ej:https://docs.google.com/spreadsheet/ccc?key=0AoYE...)" required="true" />
 <Content view="canvas" preferred_height="20px">
    <![CDATA[
		<script src="https://www.google.com/jsapi" type="text/javascript"></script>
	<script src="https://cdn.rawgit.com/sopraux/gsites/v1.0/evolucionaDigital/js/jquery.min.js" type="text/javascript"></script>
	<script src="https://cdn.rawgit.com/sopraux/gsites/v1.0/gsites-components/js/functionHelpers.js" type="text/javascript"></script>

	<style type="text/css">
	  	/* @group fonts */
		@font-face {
			font-family: 'BBVA Web Light';
			src:url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-light/web-light.eot');
			src:url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-light/web-light.eot?iefix') format("embedded-opentype"),
				url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-light/web-light.woff') format("woff"),
				url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-light/web-light.ttf') format("truetype"),
				url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-light/web-light.svg#BBVA Web Light') format("svg");
			font-style: normal;
			font-weight: normal;
		}
		@font-face {
			font-family: 'BBVA Web Book';
			src:url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-book/web-book.eot');
			src:url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-book/web-book.eot?iefix') format("embedded-opentype"),
				url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-book/web-book.woff') format("woff"),
				url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-book/web-book.ttf') format("truetype"),
				url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-book/web-book.svg#BBVA Web Book') format("svg");
			font-style: normal;
			font-weight: normal;
		}
		@font-face {
			font-family: 'BBVA Web Medium';
			src:url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-medium/web-medium.eot');
			src:url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-medium/web-medium.eot?iefix') format("embedded-opentype"),
				url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-medium/web-medium.woff') format("woff"),
				url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-medium/web-medium.ttf') format("truetype"),
				url('https://cdn.rawgit.com/sopraux/gsites/v1.0/actividadtyc/fonts/web-medium/web-medium.svg#BBVA Web Medium') format("svg");
			font-style: normal;
			font-weight: normal;
		}
		/* @end */

		.container {
			font-family: arial, sans-serif;
		    font-size: 12px;
		    margin-bottom: 16px;
		    position: relative;
		    width: 610px;
		    float: left;
		}

		.titleContainer {
			float: left;
			display: table;
		}

		.icon {
			display: inline-block;
			float: left;
		}

		.title {
			color: #0078D2;
			font-size: 30px;
			float: left;
			display: table-cell;
			margin-right: 10px;
		}

		.tag {
			display: table-cell;
			vertical-align: bottom;
			padding-bottom: 5px;
			font-weight: bold;
		}

		.line {
		    width:610px;
			margin-bottom:20px;
			margin-left:-1px;
			color:#DCDCDC;
			float: left;
		}

		.data {
			width: auto;
			background-color: #F5F5F5;
			float: left;
			border-radius: 3px;
			padding: 10px;
			margin-bottom: 10px;
			border-color: #DFE0DE;
			border-style: solid;
			border-width: 1px;
		}

		.header {
			margin-bottom: 10px;
			float: left;
			display: inline-block;
			font-size: 18px;
			width: 100%;
			font-family: BBVA Web Book, Arial;
		}

		.subHeader {
			margin-bottom: 2px;
			float: left;
			display: inline-block;
			font-size: 16px;
			color: #979797;
			width: 100%;
		}

		.row {
			margin-bottom: 10px;
			display: inline-block;
			float: left;
			font-size: 12px;
			width: 100%;
		}

		.row.last {
			margin-bottom: 0px;
		}

		.row .field {
			color: #666666;
			font-size: 12px;
			font-weight: bold;
			width: 135px;
			float: left;
		}

		.row .field::after {
			content: ':';
		}

		.row .text {
			margin-left: 135px;
		}

		.row .text.url, .row .text.email  {
			color: #0065B7;
		}

		.row .text.url {
			font-weight: bold;
		}

		.imageContainer {
			float: left;
		}

		.mapContainer {
			width: 100%;
			float: left;
			margin-top: 10px;
			margin-bottom: 10px;
		}

		.info {
			margin-left: 10px;
			display: inline-block;
			width: 420px;
		}
/*
		.assistantsContainer {
		    font-size: 13px;
		    font-family: Arial;
			margin-bottom: 15px;
		    line-height: 18px;
		    float: left;
		    width: 100%;
		}

		.assistantHeader {
			float: left;
		}

		.assistantsColumn {
			font-size: 11px;
			color: #434A58;
			display: inline-block;
			width: 80%;
			margin-left: 10px;
		}

		.assistant {
			display: inline-block;
			width: 100%;
		}
*/
		.place {
		    color: #434A58;
		    font-size: 13px;
		    font-family: Arial;
		    line-height: 18px;
		}

		.place span {
		    font-size: 13px;
		    font-family: Arial;
		    color: #0078D2;
		    line-height: 2px;
		}

		.descriptionContainer {
			margin-left: 20px;
			float: left;
		}

		.descriptionTitle {
			font-size: 18px;
		}

		.description {
		    color: #434A58;
		    font-size: 12px;
		    font-family: Arial;
		    line-height: 18px;
		    height: 36px;
		    text-overflow: ellipsis;
			display: inline-block;
			overflow: hidden;
			margin-bottom: 20px;
			float: left;
		}

		.docsContainer {
			display: inline-block;
			width: 100%;
		}

		.docContent {
			width: 100%;
			position: relative;
			height: 24px;
			float: left;
			display: table;
		}

		.icon {
			float: left;
			vertical-align: middle;
			position: relative;
			display: table-cell;
			width: 12px;
			margin-right: 10px
		}

		.uploadDocsContainer {
			float: left;
			margin-left: 20px;
			margin-top: 10px;
		}

		.docLink {
		        font-size: 12px;
			    display: table-cell;
			    cursor: pointer;
			    text-decoration: none;
			    position: relative;
			    vertical-align: middle;
			    color: #0065B7;
			    display: inline-block;
		}



		.uploadDocButton:hover {
			background: #CCCCCC;
		}

		.uploadDocButton {
		    -webkit-border-radius: .3em;
		    -moz-border-radius: .3em;
		    border-radius: .3em;
		    text-align: center;
		    font-size: 12px;
		    vertical-align: middle;
		    height: 1.75em;
		    padding-left: .9em;
		    padding-right: .9em;
		    padding-bottom: 2px;
		    cursor: pointer;
		    position: relative;
		    text-align: center;
		    vertical-align: middle;
		    margin-right: 22px;
		    margin-bottom: 20px;
		    margin-top: 20px;
		    margin-left: 0px;
		    float: left;
		    font-family: BBVA Web Light, Arial;
			font-weight: bold;
		}

		.uploadDocButton {
			border: .1em solid #CDCDCD;
			color: black;
		}

		.content {
			float: left;
			width: 100%;
		}

	</style>


	<div class="container" id="container">
		<div class="titleContainer">
			<span id="title" class="title"></span>
		</div>
		<hr class="line"/>
		<div class="data">
			<span class="header">Datos</span>
			<dl class="row">
				<dt class="field">Dirección</dt>
				<dd id="place" class="text"></dd>
			</dl>
			<dl class="row">
				<dt class="field">Persona de contacto</dt>
				<dd id="contactName" class="text"></dd>
				<dd id="contactEmail" class="text email"></dd>
			</dl>
			<dl class="row">
				<dt class="field">Horario</dt>
				<dd id="schedule" class="text"></dd>
			</dl>
			<dl class="row">
				<dt class="field">Transporte</dt>
				<dd id="transport" class="text"></dd>
			</dl>
			<dl class="row last">
				<dt class="field">Web</dt>
				<dd><a id="web" class="text url"></a></dd>
			</dl>
		</div>
		<div class="imageContainer">
			<img id="image" />
		</div>
		<div id="videoContainer" class="videoContainer">
		</div>
		<div id="mapContainer" class="mapContainer">
		</div>
		<div class="descriptionContainer">
			<div class="header">Descripción</div>
			<div id="description" class="description"></div>
			<!--
			<div class="assistantsContainer">
				<span class="assistantHeader">Asistentes:</span>
				<div id="assistants" class="assistantsColumn">

				</div>
			</div>
			 -->
			<div id="docsContainer" class="docsContainer">
			</div>
			<div id="uploadDocsContainer" class="uploadDocsContainer">
				<span class="header">¿Tienes algún documento sobre el evento?</span>
				<div class="content">
					<span class="subHeader">Introduce el enlace al documento</span>
					<input id="docLink" type="text"/>
				</div>
				<div class="content" style="margin-top:10px">
					<span class="subHeader">Introduce el nombre del documento</span>
					<input id="docName" type="text"/>
				</div>
				<div class="content">
					<button id="uploadDocButton" onclick='javascript:uploadDoc()' class="uploadDocButton">Añadir documento</button>
				</div>
			</div>
		</div>
	</div>

   	<script type="text/javascript">
    		var dataUser;
    		var eventDate;

    		var dataForm = {
      		'key': '1hZ2TFoq3ihf7d9lVT7hx3P3cSui7kaG5s7zR781GnL8',
      		'numberTab': 0
    		};

    		$.ajax({
      		type: 'GET',
      		url: 'https://script.google.com/a/macros/bbva.com/s/AKfycbwCX4Zk9LdOGjUinuU7bPKFVCVkNtKqRJPlqcZf87MECPgfT3cs/exec',
      		data: dataForm,
      		dataType: 'jsonp',
      		crossDomain: true,
      		jsonpCallback: "on_result",
      		success: function (data) {
      			//Eliminamos la primera fila ya que no es necesaria
      			data.splice(0, 1);

      			getQueryParameters();
      			handleQueryResponse(data, 0);
      		},
      		error: function () {
      			console.log('error');
      		}
    		});

    	function getParam(p) {
    		var params;
    		//if (location.href.split("?").length > 1) {
    		if(gadgets.util.getUrlParameters().parent.split("?").length > 1){
    		params = gadgets.util.getUrlParameters().parent.split("?")[1].split("&");
    		//params = location.href.split("?")[1].split("&");
    			for (var i = 0; i < params.length; i++) {
    				if (params[i].split("=")[0] == p)
    					return params[i].split("=")[1];
    			}
    		}
    		return "";
    	}

    	function getQueryParameters() {
    		var filter = "";

    		var id = getParam('id');

    		if (id != "" && id > 0)
    			filter += " AND A =" + id;

    		return filter;
    	}

    		function sendQuery() {
    		//var spreadsheetKey = prefs.getString('spreadsheetKey'),
    		/*var spreadsheetKey = '1hZ2TFoq3ihf7d9lVT7hx3P3cSui7kaG5s7zR781GnL8',
    							sheetName = encodeURIComponent('events'),
    							queryString = encodeURIComponent('SELECT * where B <> "title"' + getQueryParameters()),
    							query = new google.visualization.Query('https://spreadsheets.google.com/tq?key=' + spreadsheetKey + '&sheet=' + sheetName + '&tq=' + queryString);
    							query.send(function (response) {
    								handleQueryResponse(response, 0);
    						});*/
    		}


    		function handleQueryResponse(data, index) {
    		/*	data = response.getDataTable();*/
    		//dataGlobal -> data = 1º spreedSheet -> 1hZ2TFoq3ihf7d9lVT7hx3P3cSui7kaG5s7zR781GnL8
    		var operativa = getParam("id");
    		console.log("OPERATIVA- >" + operativa);
    		/*if (operativa != '') {
    			data = valueOperative(data);
    		}*/

    		dataGlobal = data;
    		var address;
    		var contact;
    		var contactEmail;
    		var schedule;
    		var transport;
    		var web;
    		var map;
    		var image;
    		var video;
    		var description;

    		if (index == 0) {
    			dataGlobal.find(function (elem) {
    				eventDate = elem[5];
    				if (eventDate == 'undefined' || eventDate == null || eventDate == '')
    					eventDate = elem[4];

    				if (elem[0] == operativa) {
    					title = elem[1];
    					address = elem[7];
    					contact = elem[8];
    					contactEmail = elem[9];
    					schedule = elem[10];
    					transport = elem[11];
    					web = elem[12];
    					map = elem[13];
    					image = elem[14];
    					video = elem[15];
    					description = elem[2];
    					console.log(address);
    				}
    			});

    			var tagConfirm = "";

    			$('#title').html(title);
    			document.getElementById('place').innerHTML = address;
    			document.getElementById('contactName').innerHTML = contact;
    			document.getElementById('contactEmail').innerHTML = contactEmail;
    			document.getElementById('schedule').innerHTML = schedule;
    			document.getElementById('transport').innerHTML = transport;
    			document.getElementById('web').innerHTML = web;
    			document.getElementById('description').innerHTML = description;

    			if (map != '' && map != 'undefined' && map != null) {
    				var iframeMap = "";
    				iframeMap += '<iframe id="map" src="' + map + '" style="height: 300px;" width="100%" frameborder="0" style="border:0" allowfullscreen></iframe>';
    				document.getElementById('mapContainer').innerHTML = iframeMap;
    			}

    			if (image != '' && image != 'undefined' && image != null) {
    				document.getElementById('image').src = image;
    			}

    			if (video != '' && video != 'undefined' && video != null) {
    				document.getElementById('videoContainer').innerHTML = "<iframe src='" + video + "'   allowfullscreen='true' allowScriptAccess='always' style='border:0px solid #AAA; width:100%; height:300px; '></iframe>";
    			}

    		} else if (index == 2) {
    			sendQueryDocs();
    			var filas = data.length;
    			html = "";
    			if (filas > 0)
    				html += '<span class="header">Documentación:</span>';
    			for (var i = 0; i < filas; i++) {
    				html += '<div class="docContent">';
    				html += '	<img class="icon" src="https://raw.githubusercontent.com/sopraux/gsites/master/actividadtyc/img/pdf.png"/>';
    				html += '	<a class="docLink" onclick=javascript:Go("' + elem[2] + '")>' + elem[1] + '</a>';
    				html += '</div>';
    			}
    			document.getElementById('docsContainer').innerHTML = html;
    		}

    		}

    		function getQueryParametersUsers() {
    		var filter = "";

    		var id = getParam('id');

    		if (id != "" && id > 0)
    			filter += " AND A =" + id;

    		filter += " AND C ='x'";

    		return filter;
    	}

    		function getQueryParametersDocs() {
    		var filter = "";

    		var id = getParam('id');

    		if (id != "" && id > 0)
    			filter += " AND A =" + id;

    		return filter;
    	}

    		function sendQueryDocs() {
    		var dataForm = {
    			'key': '1hZ2TFoq3ihf7d9lVT7hx3P3cSui7kaG5s7zR781GnL8',
    			'numberTab': 0
    		};

    		$.ajax({
    			type: 'GET',
    			url: 'https://script.google.com/a/macros/bbva.com/s/AKfycbyPKcDJzBWVSlwWOugDVov87-_xXlEFfWXa7adIswtNXNtM-mdv/exec',
    			data: dataForm,
    			dataType: 'jsonp',
    			crossDomain: true,
    			jsonpCallback: "on_result",
    			success: function (data) {
    				//Eliminamos la primera fila ya que no es necesaria
    				data.splice(0, 1);

    				getQueryParametersDocs();
    				handleQueryResponse(data, 2);
    			},
    			error: function () {
    				console.log('error');
    			}
    		});

    		}


    	function Go(destination) {
    		window.open(destination, '_blank');
    		//window.parent.location.href = destination;
    		return false;
    		}

    		//delay loading
    		delayRender();
    	function delayRender() {
    		window.setTimeout('showIframes()', 2000);
    	}

    	function showIframes() {
    		 	var iframes = document.getElementsByClassName('youtubeIframe').length;
    		 	for (var i = 0; i < iframes; i++) {
    			document.getElementsByClassName('youtubeIframe')[i].style.display = 'block';
    		}
    	}


    	function uploadDoc() {
    		var link = document.getElementById("docLink").value;
    		var name = document.getElementById("docName").value;
    		var id = getParam('id');

    		if (name != '' && name != null) {
    			if (link != "" && link != null && link.startsWith("http")) {
    				$.ajax({
    					type: 'GET',
    					url: 'https://script.google.com/a/macros/bbva.com/s/AKfycbwBnJc-wVyxF4xZ9kcibmEiNTKzi9bfkWqrjVZLtXiGPP2OAME/exec?id=' + id + '&link=' + link + '&name=' + name,
    					dataType: 'jsonp',
    					jsonpCallback: "on_result",
    					success: function (data) {
    						var result = JSON.parse(data);
    						console.log(result);
    						var htm = document.getElementById('docsContainer').innerHTML;
    						if (htm == "" || htm == null)
    							htm += '<span class="header">Documentación:</span>';

    						htm += '<div class="docContent">';
    						htm += '	<img class="icon" src="https://raw.githubusercontent.com/sopraux/gsites/master/actividadtyc/img/pdf.png"/>';
    						htm += '	<a class="docLink" onclick=javascript:Go("' + link + '")>' + name + '</a>';
    						htm += '</div>';
    						document.getElementById('docsContainer').innerHTML = htm;
    						document.getElementById("docLink").value = '';
    						document.getElementById("docName").value = '';
    					}
    				});
    			}
    			else {
    				alert("El enlace no es válido");
    			}
    		}
    		else
    			alert("El nombre esta vacío");
    	}


    	function pastDate(eventDate) {
    		var ed = eventDate.split('/');

    		var eDate = Date.UTC(ed[2], ed[1], ed[0]);
    		var dateObj = new Date();
    		var actDate = dateObj.getTime();

    		if (actDate > eDate)
    			return true;
    		else
    			return false;
    	}

  	</script>

    ]]>
  </Content>

  <Content type="html" view="configuration">

    <![CDATA[

      <style type="text/css">

        table td {
          color: #000;
          font-size: 11px;
          font-weight: bold;
        }

      </style>

      <table width="100%" border="0" id="tablaconfig">
        <tr>
          <td>
            Spreadsheet Key: <input type="text" id="spreadsheetKey" value="__UP_spreadsheetKey__"   onchange="register('spreadsheetKey')"/>
          </td>
        </tr>
      </table>

      <script type="text/javascript">

        var prefs = new gadgets.Prefs();
        function register(variable) {
          prefs.set(variable, document.getElementById(variable).value);
        }

        gadgets.window.adjustHeight();

      </script>

    ]]>
  </Content>

</Module>
