<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="AC-tagCloud.xml"
    description="">
    <Require feature="idi"/>
    <Require feature="locked-domain" />
	<Require feature="dynamic-height"/>
	<Require feature="setprefs" />
  </ModulePrefs>
	<UserPref name="spreadsheetKey" default_value="" display_name="Data source url (Ej:https://docs.google.com/spreadsheet/ccc?key=0AoYE...)" required="true" />
 <Content view="canvas" preferred_height="20px">
    <![CDATA[
	<script src="https://www.google.com/jsapi" type="text/javascript"></script>
	<script src="https://rawgit.com/sopraux/gsites/master/evolucionaDigital/js/jquery.min.js" type="text/javascript"></script>
	<script src="https://rawgit.com/sopraux/gsites/master/gsites-components/js/functionHelpers.js" type="text/javascript"></script>	

	<style type="text/css">
	  	/* @group fonts */
		@font-face {
			font-family: 'BBVA Web Light';
			src:url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-light/web-light.eot');
			src:url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-light/web-light.eot?iefix') format("embedded-opentype"),
				url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-light/web-light.woff') format("woff"),
				url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-light/web-light.ttf') format("truetype"),
				url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-light/web-light.svg#BBVA Web Light') format("svg");
			font-style: normal;
			font-weight: normal;
		}
		@font-face {
			font-family: 'BBVA Web Book';
			src:url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-book/web-book.eot');
			src:url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-book/web-book.eot?iefix') format("embedded-opentype"),
				url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-book/web-book.woff') format("woff"),
				url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-book/web-book.ttf') format("truetype"),
				url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-book/web-book.svg#BBVA Web Book') format("svg");
			font-style: normal;
			font-weight: normal;
		}
		@font-face {
			font-family: 'BBVA Web Medium';
			src:url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-medium/web-medium.eot');
			src:url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-medium/web-medium.eot?iefix') format("embedded-opentype"),
				url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-medium/web-medium.woff') format("woff"),
				url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-medium/web-medium.ttf') format("truetype"),
				url('https://github.com/sopraux/gsites/raw/master/evolucionaDigital/fonts/web-medium/web-medium.svg#BBVA Web Medium') format("svg");
			font-style: normal;
			font-weight: normal;
		}
		/* @end */

        body {
            font-family: BBVA Web Book, Arial;
        }

        .container {
            border: 1px solid #DDE3EA;
            border-radius: 2px 2px 2px 2px;
            clear: both;
            margin-top: 15px;
            width: 275px;
            float: left;
        }

		.title {
            background: #ffffff; /* Old browsers */
            background: -moz-linear-gradient(top,  #ffffff 0%, #f5f7f8 100%); /* FF3.6+ */
            background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffffff), color-stop(100%,#f5f7f8)); /* Chrome,Safari4+ */
            background: -webkit-linear-gradient(top,  #ffffff 0%,#f5f7f8 100%); /* Chrome10+,Safari5.1+ */
            background: -o-linear-gradient(top,  #ffffff 0%,#f5f7f8 100%); /* Opera 11.10+ */
            background: -ms-linear-gradient(top,  #ffffff 0%,#f5f7f8 100%); /* IE10+ */
            background: linear-gradient(to bottom,  #ffffff 0%,#f5f7f8 100%); /* W3C */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#f5f7f8',GradientType=0 ); /* IE6-9 */
            border-bottom: 1px solid #DDE3EA;
            color: #333333;
            font-family: BBVA Web Book,Arial;
            font-size: 16px;
            padding-bottom: 15px;
            padding-left: 18px;
            padding-top: 14px;
        }


        select {
            width:220px;
        }
        .ui-widget-content {
            background: white;
        }

        .tagsContainer {
            float: left;
            padding: 15px;
        }

        .tag {
            float: left;
            padding: 5px;
            margin: 3px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }

        .tagText {
            color: #FFFFFF;
        }

        .tagTextBlue {
            color: #0072C9;
        }

        .all {
            background-color: rgba(0, 115, 201, 1);
        }

        .many {
            background-color: rgba(0, 115, 201, 0.75);
        }

        .some {
            background-color: rgba(0, 115, 201, 0.25);
        }

        .almost {
            background-color: rgba(0, 115, 201, 0.1);
        }
        

	</style>


	<div class="container">
        <div class="title">Etiquetas</div>
        <div id="tagsContainer" class="tagsContainer">
            
        </div>
    </div>
    </div>

   	<script type="text/javascript">
   		
   		adjustGadgetHeight('container');
		var gadgetHelper = null;
        var encontrados = [];
        var releases;
        var maxNumber = 0;
		google.load('visualization', '1', {packages: ['table']});
        google.setOnLoadCallback(sendQuery);
        var prefs = new gadgets.Prefs();


	 	function loadVisualizationAPI() {
			google.load("visualization", "1", {"packages": ["table"]});
			google.setOnLoadCallback(sendQuery);
		}


		function sendQuery(){
			var spreadsheetKey = prefs.getString('spreadsheetKey'),
			//var spreadsheetKey = '1hZ2TFoq3ihf7d9lVT7hx3P3cSui7kaG5s7zR781GnL8',
                sheetName = encodeURIComponent('External Releases'),
                queryString = encodeURIComponent('SELECT * where A <> "TÃ­tulo"'),
                query = new google.visualization.Query('https://spreadsheets.google.com/tq?key=' + spreadsheetKey + '&sheet=' + sheetName + '&tq=' + queryString);
                alert(spreadsheetKey);
                query.send(function (response) {
                	handleQueryResponse(response, 0);
            	});
		}


		function handleQueryResponse(response, index) {
			data = response.getDataTable();

            getTagValues(data);
            var html = "";
            var url = encodeURIComponent(parent.location.href);
            var clase = "";
            var claseText = "";
            alert(url);
            for(var i=0; i<encontrados.length; i++){
                
                claseText = "tagText";
                if(releases[i].length < 0.75 * maxNumber){
                    if(releases[i].length < 0.5 * maxNumber){
                        claseText = "tagTextBlue";
                        if(releases[i].length > 0.25 * maxNumber)
                            clase = "some";
                        else
                            clase = "almost";
                    }
                    else
                        clase = "many";
                }
                else
                    clase = "all";

                html += '<div class="tag '+clase+'" onclick="javascript:Go(\''+url+'?tag='+encodeURIComponent(encontrados[i])+'\')">';
                html += '<span class="'+claseText+'">'+encontrados[i]+' ('+releases[i].length+')</span></div>';
            }	
            document.getElementById('tagsContainer').innerHTML = html;
		}
		

	    function Go(destination){
	    	//window.open(destination,'_parent');
		    window.parent.location.href = destination;
		    return false;
		}

        function getTagValues(data) {

            var s = 0;
            var fin = false;
            var rows = data.getNumberOfRows();
            
            for(var i=0; i<rows; i++){
                if( encontrados.indexOf(data.getValue(i, 3)) == -1  &&  data.getValue(i, 3)!=null ) {
                    encontrados[s++] = data.getValue(i, 3);
                }
            }

            releases = [];
            for(var i=0; i<encontrados.length; i++)
                releases[i] = [];

            for(var i=0; i<encontrados.length; i++){
                for(var j=0; j<rows; j++){
                    if(encontrados[i] == data.getValue(j, 3))
                        releases[i].push(data.getValue(j, 0));
                }
            }

            maxNumber = 0;
            for(var i=0; i<encontrados.length; i++){
                if(releases[i].length > maxNumber)
                    maxNumber = releases[i].length;
            }

        }


  	</script>

    ]]>
  </Content>

  <Content type="html" view="configuration">

    <![CDATA[

      <style type="text/css">

        table td {
          color: #000;
          font-size: 11px;
          font-weight: bold;
        }

      </style>

      <table width="100%" border="0" id="tablaconfig">
        <tr>
          <td>
            Spreadsheet Key: <input type="text" id="spreadsheetKey" value="__UP_spreadsheetKey__"   onchange="register('spreadsheetKey')"/>
          </td>
        </tr>
      </table>

      <script type="text/javascript">

        var prefs = new gadgets.Prefs();
        function register(variable) {
          prefs.set(variable, document.getElementById(variable).value);
        }

        gadgets.window.adjustHeight();

      </script>

    ]]>
  </Content>

</Module>
