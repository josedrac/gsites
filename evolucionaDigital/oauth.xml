<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    <ModulePrefs title="ED-oauth.xml"
        description=""
        author_affiliation="Sopra">
        <Require feature="idi"/>
        <Require feature="locked-domain" />
    	<Require feature="dynamic-height"/>
    	<Require feature="setprefs" />
    </ModulePrefs>
	<UserPref name="_table_query_url" default_value="" display_name="Data source url (Ej:https://docs.google.com/spreadsheet/ccc?key=0AoYEewut2JmZdG5HM2VLTTdwQUlLdmhnMk1DLXBWZl)" required="true" />

    <Content type="html">
        <![CDATA[
	        <script src="https://www.google.com/jsapi" type="text/javascript"></script>

            <div>
                <button id="authorize-button" style="visibility: hidden">Authorize</button>
            </div>

            <script type="text/javascript">

                console.log('Loading Oauth');

                function makeRequest (method, url) {
                    return new Promise(function (resolve, reject) {
                        var xhr = new XMLHttpRequest();
                        xhr.open(method, url);
                        xhr.onload = function () {
                            if (this.status >= 200 && this.status < 300) {
                                resolve(xhr.response);
                            } else {
                                reject({
                                    status: this.status,
                                    statusText: xhr.statusText
                                });
                            }
                        };
                        xhr.onerror = function () {
                            reject({
                                status: this.status,
                                statusText: xhr.statusText
                            });
                        };
                        xhr.send();
                    });
                }

                // NOTE: You must replace the client id on the following line.
                var clientId = '872842019185-v0c6ckaa1jp8nbl2dq37e9nuh0b847p5.apps.googleusercontent.com';
                var scopes = 'https://spreadsheets.google.com/feeds';

                var init = function() {
                    gapi.auth.authorize(
                        {client_id: clientId, scope: scopes, immediate: true},
                        handleAuthResult
                    );
                }

                var handleAuthResult = function(authResult) {
                    var authorizeButton = document.getElementById('authorize-button');
                    if (authResult && !authResult.error) {
                        authorizeButton.style.visibility = 'hidden';
                        makeApiCall();
                    } else {
                        authorizeButton.style.visibility = '';
                        authorizeButton.onclick = handleAuthClick;
                    }
                }

                var handleAuthClick = function(event) {
                    gapi.auth.authorize(
                        {client_id: clientId, scope: scopes, immediate: false},
                        handleAuthResult
                    );
                    return false;
                }

                var makeApiCall = function() {
                    var token = gapi.auth.getToken().access_token;

                    var tqUrl = 'https://docs.google.com/a/bbva.com/spreadsheets/d/1kdVF8ka3_H73dLgFrLfD8L_yDnMSs9PVPBt8UpIe5G4/gviz/tq' +
                    '?usp=sharing&tq=select%20*%20where%20A%20%3C%3E%20%27IdImplantacion%27%20order%20by%20G%20desc%2C%20F%20desc&tqx=reqId%3A0' +
                    '&access_token=' + encodeURIComponent(token);

                    console.log(encodeURIComponent(gapi.auth.getToken().access_token));

                    makeRequest('GET', tqUrl).then(function (datums) {
                      console.log(datums);
                    }).catch(function (err) {
                      console.error('Augh, there was an error!', err.statusText);
                    });

                }

                var handleTqResponse = function(resp) {
                    document.write(JSON.stringify(resp));
                }

            </script>

            <script src="https://apis.google.com/js/auth.js?onload=init"></script>

        ]]>
    </Content>

</Module>
