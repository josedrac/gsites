<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    <ModulePrefs title="ED-oauth.xml"
        description=""
        author_affiliation="Sopra">
        <Require feature="idi"/>
        <Require feature="locked-domain" />
    	<Require feature="dynamic-height"/>
    	<Require feature="setprefs" />
    </ModulePrefs>
	<UserPref name="_table_query_url" default_value="" display_name="Data source url (Ej:https://docs.google.com/spreadsheet/ccc?key=0AoYEewut2JmZdG5HM2VLTTdwQUlLdmhnMk1DLXBWZl)" required="true" />

    <Content type="html">
        <![CDATA[
	        <script src="https://www.google.com/jsapi" type="text/javascript"></script>
            <script src="https://apis.google.com/js/auth.js" type="text/javascript"></script>

            <div>
                <button id="authorize-button" style="visibility: hidden">Authorize</button>
                <div id="listImplantaciones"></div>
            </div>

            <script type="text/javascript">

                console.log('Loading Oauth');

                var gadgetHelper = null;
        		var prefs = new _IG_Prefs();
        	 	var urlTable = prefs.getString("_table_query_url");
                console.log('urlTable', urlTable);
                _IG_RegisterOnloadHandler(loadVisualizationAPI);

                function isSearchDone() {
        	        if (gadgets.util.getUrlParameters().parent.split("=").length >= 2) {
        	            return true;
        	        }
        	        return false;
        	    }

         		function getSelectedSecondValue() {
        	        return gadgets.util.getUrlParameters().parent.split("=")[2];
        	    }

        	    function getSelectedFirstValue() {
        	        return gadgets.util.getUrlParameters().parent.split("=")[1].split("&")[0];
        	    }

        	    function getSelectedFirstParameter() {
        	        return gadgets.util.getUrlParameters().parent.split("=")[0].split("?")[1];
        	    }

        	    function getQueryParameters() {
            		var filter = "";
            		if (isSearchDone()){
            			var firstParam = getSelectedFirstParameter();
        	    		var first = getSelectedFirstValue();
        	    		if (firstParam == "anyo" && first > 0) {
        	    			filter = " AND (G = "+first+")";
        	    		} else if (firstParam == "inputText") {
        	    			first= first.toLowerCase();
        	    			filter = " AND (lower(B) like '%"+first+"%' OR lower(C) like '%"+first+"%' OR lower(D) like '%"+first+"%' OR lower(E) like '%"+first+"%')";
        	    		}
        	    		var second = getSelectedSecondValue();
        	    		if (second > 0) {
        	    			filter = filter.concat(" AND (F = "+second+")");
        	    		}
        	    	}
            		return filter;
        	    }

                function handleQueryResponse(response) {
                    console.log('response', response);
        			data = response.getDataTable();
        			var filas = data.getNumberOfRows();
        			var html = "";

        			var month = new Array();
        			month[1] = "Ene";
        			month[2] = "Feb";
        			month[3] = "Mar";
        			month[4] = "Abr";
        			month[5] = "May";
        			month[6] = "Jun";
        			month[7] = "Jul";
        			month[8] = "Agt";
        			month[9] = "Sep";
        			month[10] = "Oct";
        			month[11] = "Nov";
        			month[12] = "Dic";

        			if(filas < 1)
            			html += '<p class="text">No hay ningún contenido para las fechas seleccionadas.</p>';
                    else {
                        html += '<div id="paginas" class="paginaNueva" style=" display: block;">';

        				for(var i=0; i < filas; i++) {

        				   	html += "<div class='implantation'>";

        				   	//Fecha
        				   	html += "<div class='datesandtags'><div class='date'>";
        					html += "<div class='month' id='mes'>" + month[data.getValue(i,5)] + "</div>";
        					html += "<div class='year' id='anyo'>" + data.getValue(i,6) + "</div>";
        				    html += "</div></div>";

        					//Contenido
        				   	html += "<div class='info'>";
        				   	html += "<div class='title'>" + data.getValue(i,1) + "</div>";
        				   	html += "<div class='destinatarios'>Destinatarios: <span>" + data.getValue(i,2) + "</span></div>";
        				   	html += "<div class='ambito'>Ámbito: <span>" + data.getValue(i,3) + "</span></div>";
        				   	html += "<div class='description'>" + data.getValue(i,4) + "</div>";
        				    html += "<button type='button' onclick=javascript:Go('" + data.getValue(i,7) + "')>Saber más</button>";
        				    html += "</div>";

        					//Separación
        				    html += "<img src='https://github.com/sopraux/gsites/raw/menu/evolucionaDigital/img/lineborder.png' class='lineinfo'/></div>";
        	            }

        	            html += '</div>';
        	        }
        			html += "<div id='pagination' style='margin: auto;'></div>";

        			document.getElementById('listImplantaciones').innerHTML += html;
        			gadgets.window.adjustHeight();
        		}

                function sendQuery(url, params){
                    console.log('send query');
        			gadgetHelper = new google.visualization.GadgetHelper();
        			var opts = {dataType:'jsonp'};
        			var query = new google.visualization.Query(url, opts);
        			var querytosend = "select * where A <> 'IdImplantacion'";
        			querytosend = querytosend.concat(getQueryParameters());
        			var orderQuery = " order by G desc, F desc"
        			querytosend = querytosend.concat(orderQuery);
        			query.setQuery(params);
        			query.send(handleQueryResponse);
        		}

                function makeRequest (method, url, body) {
                    return new Promise(function (resolve, reject) {
                        var xhr = new XMLHttpRequest();
                        xhr.open(method, url);
                        xhr.onload = function () {
                            if (this.status >= 200 && this.status < 300) {
                                resolve(xhr.response);
                            } else {
                                reject({
                                    status: this.status,
                                    statusText: xhr.statusText
                                });
                            }
                        };
                        xhr.onerror = function (err) {
                            reject({
                                status: this.status,
                                statusText: xhr.statusText
                            });
                        };
                        xhr.send(body);
                    });
                }

                var clientId = '872842019185-v0c6ckaa1jp8nbl2dq37e9nuh0b847p5.apps.googleusercontent.com';
                var scopes = 'https://spreadsheets.google.com/feeds';

                var init = function() {
                    gapi.auth.authorize(
                        {client_id: clientId, scope: scopes, immediate: true},
                        handleAuthResult
                    );
                }

                var handleAuthResult = function(authResult) {
                    var authorizeButton = document.getElementById('authorize-button');
                    if (authResult && !authResult.error) {
                        authorizeButton.style.visibility = 'hidden';
                        makeApiCall();
                    } else {
                        authorizeButton.style.visibility = '';
                        authorizeButton.onclick = handleAuthClick;
                    }
                }

                var handleAuthClick = function(event) {
                    console.log('GENERATING NEW TOKEN');
                    gapi.auth.authorize(
                        {client_id: clientId, scope: scopes, immediate: false},
                        handleAuthResult
                    );
                    return false;
                }

                var read_token = function(){
                    console.log('READING TOKEN FROM DRIVE');
                    var url = "https://sheets.googleapis.com/v4/spreadsheets/1VpOkfY_vGu8htFkc0D-2iiTymFT5u9PAH7tDuBUFb4U/values/hoja!A1:A1" +
                    "?apiKey=AIzaSyD1EsKyPTV3HB3FrTaB3Dmm7vtk7UmQNCw";
                    console.log('url: ', url);
                    makeRequest('GET', url).then(function (datums) {
                          console.log('READED TOKEN FROM DRIVE: ', datums);
                    }).catch(function (err) {
                          console.error('ERROR READING TOKEN FROM DRIVE: ', err.statusText);
                    });


                    //gapi.client.init({
                    //  'apiKey': 'AIzaSyD1EsKyPTV3HB3FrTaB3Dmm7vtk7UmQNCw',
                    //}).then(function() {
                    //    console.log("gapi init done");
                    //    gapi.client.sheets.spreadsheets.values.get({
                    //        spreadsheetId: '1VpOkfY_vGu8htFkc0D-2iiTymFT5u9PAH7tDuBUFb4U',
                    //        range: 'hoja!A1:A1',
                    //    }).then(function(response) {
                    //        console.log('final: ', response);
                    //    }).catch(function(err){
                    //        console.log('final error', err);
                    //    });
                    //}).catch(function(err){
                    //    console.log('pre final error: ', error);
                    //});
                }

                var makeApiCall = function() {
                    var token = gapi.auth.getToken().access_token;
                    console.log('TOKEN GENERATED: ', token);

                    //var url = "https://docs.google.com/a/bbva.com/spreadsheets/d/1kdVF8ka3_H73dLgFrLfD8L_yDnMSs9PVPBt8UpIe5G4/gviz/tq?access_token=" + encodeURIComponent(token);
                    //var params = "select * where A <> 'IdImplantacion' order by G desc, F desc";
                    //console.log('url: ', url);
                    //console.log('params: ', params);
                    //sendQuery(url, params);

                    //var url = "https://docs.google.com/a/bbva.com/spreadsheets/d/1kdVF8ka3_H73dLgFrLfD8L_yDnMSs9PVPBt8UpIe5G4/gviz/tq?";
                    //console.log('url: ', url);
                    //console.log('params: ', params);
                    //sendQuery(url, params);

                    console.log('PUTTING TOKEN ON DRIVE');
                    var csv_data = {
                        "values": [
                            [
                                token
                            ]
                        ]
                    }
                    var url = "https://sheets.googleapis.com/v4/spreadsheets/1VpOkfY_vGu8htFkc0D-2iiTymFT5u9PAH7tDuBUFb4U/values/hoja!A1:A1?valueInputOption=raw&access_token=" + encodeURIComponent(token);
                    console.log('url: ', url);
                    console.log('csv_data: ', csv_data);
                    makeRequest('PUT', url, JSON.stringify(csv_data)).then(function (datums) {
                      console.log('TOKEN PUT ON DRIVE: ', datums);
                      read_token();
                    }).catch(function (err) {
                      console.error('Augh, there was an error!', err.statusText);
                    });

                }

                var handleTqResponse = function(resp) {
                    document.write(JSON.stringify(resp));
                }

                function loadVisualizationAPI() {
                    console.log('load');
                    google.load("visualization", "1", {"packages": ["table"]});
                    google.setOnLoadCallback(init);
                }


            </script>

            <!-- <script src="https://apis.google.com/js/auth.js?onload=init"></script> -->

        ]]>
    </Content>

</Module>
