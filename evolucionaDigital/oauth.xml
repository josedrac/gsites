<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="ED-oauth.xml"
    description=""
    author_affiliation="Sopra">
    <Require feature="idi"/>
    <Require feature="locked-domain" />
	<Require feature="dynamic-height"/>
	<Require feature="setprefs" />
  </ModulePrefs>
	<UserPref name="_table_query_url" default_value="" display_name="Data source url (Ej:https://docs.google.com/spreadsheet/ccc?key=0AoYEewut2JmZdG5HM2VLTTdwQUlLdmhnMk1DLXBWZl)" required="true" />

 <Content type="html">
    <![CDATA[
	<script src="https://www.google.com/jsapi" type="text/javascript"></script>


    <div id="listportales"></div>

   <script type="text/javascript">
	 var gadgetHelper = null;
	 var prefs = new _IG_Prefs();
	 var urlTable = prefs.getString("_table_query_url");
	 var emailTo = prefs.getString("emailTo");
	 var portalContenido = gadgets.util.getUrlParameters()["parent"].split("=");
	 var situation = gadgets.util.getUrlParameters()["parent"];
	 _IG_RegisterOnloadHandler(loadVisualizationAPI);

	 function loadVisualizationAPI()
			{
				google.load("visualization", "1", {"packages": ["table"]});
				google.setOnLoadCallback(sendQuery);
			}

		function sendQuery()
			{
				gadgetHelper = new google.visualization.GadgetHelper();
				var opts = {dataType:'jsonp'};
				var query = new google.visualization.Query(urlTable, opts);
				var querytosend = "select * where A like '"+portalContenido[1]+"' ";
				query.setQuery(querytosend);
				query.send(handleQueryResponse);


			}
		function handleQueryResponse(response) {
			   data = response.getDataTable();
			   var filas = data.getNumberOfRows();
			   var html = "";
			   html += "<div id='titlecomboVideo'><h2>"+data.getValue(0,1)+"</h2></div><img src='https://github.com/sopraux/gsites/raw/menu/evolucionaDigital/img/lineborder.png' class='linetitle'/>";

			for(var i=0; i<filas;i++){
                html +="<div id='userBBVA'>";
                html += getIcons(data, i);
                html +="<div id='dateVideo'>"+data.getFormattedValue(i,2)+" - </div>";
                html +="<div id='userVideo'>"+data.getValue(i,5)+"</div>";
                html +="<div class='smalldescription'>"+data.getValue(i,3)+"</div>";
                html +="<div id='video'>";
                if(data.getValue(i,7) != null && typeof data.getValue(i,7) != 'undefined' && data.getValue(i,7) !== undefined && data.getValue(i,7) != ""){
                    if(data.getValue(i,7).startsWith('https://www.youtube.com'))
                        html += "<iframe src='"+data.getValue(i,7)+"'   allowfullscreen='true' allowScriptAccess='always' style='border:0px solid #AAA; width:575px; height:400px; '></iframe>";
                    else
                        html += "<video src='"+data.getValue(i,7)+"' style='border:0px solid #AAA; width:575px; height:400px; ' controls>Tu navegador no implementa el elemento <code>video</code></video></div>";
                }else{
                    html +="<img src='"+data.getValue(i,16)+"' />";
			    }
                html += "</div>";
                html += "<div class='description'>"+data.getValue(i,4)+"</div>";

                if(data.getValue(i,8) != null  &&  data.getValue(i,8) != ""){
                  html += "<div class='button-container'>";
                  html += " <button onclick=\"javascript:Go('"+data.getValue(i,8)+"')\">MÃ¡s info</button>";
                  html += "</div>";
                }

			    html +="</div>";
			}
				document.getElementById('listportales').innerHTML = html;
                }

        function getIcons(data, row) {
            var html = "<div class='icons'>";
                var iconCols = {
                9: ['https://raw.githubusercontent.com/sopraux/gsites/master/evolucionaDigital/img/cellphone.png', 10, 16],
                10: ['https://raw.githubusercontent.com/sopraux/gsites/master/evolucionaDigital/img/cellphone.png', 10, 16],
                11: ['https://raw.githubusercontent.com/sopraux/gsites/master/evolucionaDigital/img/cellphone.png', 10, 16],
                12: ['https://raw.githubusercontent.com/sopraux/gsites/master/evolucionaDigital/img/mouse.png', 11, 16],
                13: ['https://raw.githubusercontent.com/sopraux/gsites/master/evolucionaDigital/img/tablet.png', 13, 16],
                14: ['https://raw.githubusercontent.com/sopraux/gsites/master/evolucionaDigital/img/phone.png', 15, 15]
                };
            var isCellphoneShown = false;
            var countIcons = 0;
            for (var column in iconCols) {
                if (!iconCols.hasOwnProperty(column)) {
                    continue;
                }

                if (isCellphoneShown && (column == 9 || column == 10 || column == 11)) {
                    continue;
                }

                if (data.getValue(row, parseInt(column)) !== 'x') {
                    continue;
                }

                if (column == 9 || column == 10 || column == 11) {
                    isCellphoneShown = true;
                }

                if (countIcons == 0) {
                    html += "<div class='icon'><img src='"+iconCols[column][0]+"' style='width:"+iconCols[column][1]+"; height:"+iconCols[column][2]+";' /></div>";
                    countIcons++;
                    continue;
                }

                html += "<div class='icon'><img src='"+iconCols[column][0]+"' style='width:"+iconCols[column][1]+"; height:"+iconCols[column][2]+";margin-left: 10px !important;' /></div>";
                countIcons++;

            }
            html += "</div>";
            html += "<div class='clearBoth'></div>";
            return html;
        }

        function Go(destination){
  				window.open(destination,'_blank');
  			    //window.parent.location.href = destination;
  			    return false;
  			}


  </script>
    ]]>
  </Content>

</Module>
