<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    <ModulePrefs title="ED-oauth.xml"
        description=""
        author_affiliation="Sopra">
        <Require feature="idi"/>
        <Require feature="locked-domain" />
    	<Require feature="dynamic-height"/>
    	<Require feature="setprefs" />
    </ModulePrefs>
	<UserPref name="_table_query_url" default_value="" display_name="Data source url (Ej:https://docs.google.com/spreadsheet/ccc?key=0AoYEewut2JmZdG5HM2VLTTdwQUlLdmhnMk1DLXBWZl)" required="true" />

    <Content type="html">
        <![CDATA[
	        <script src="https://www.google.com/jsapi" type="text/javascript"></script>
            <script src="https://apis.google.com/js/auth.js" type="text/javascript"></script>

            <div>
                <button id="authorize-button" style="visibility: hidden">Authorize</button>
                <div id="listImplantaciones"></div>
            </div>

            <script type="text/javascript">

                console.log('Loading Oauth');

                var gadgetHelper = null;
        		var prefs = new _IG_Prefs();
        	 	var urlTable = prefs.getString("_table_query_url");
                console.log('urlTable', urlTable);
                _IG_RegisterOnloadHandler(loadVisualizationAPI);

                function isSearchDone() {
        	        if (gadgets.util.getUrlParameters().parent.split("=").length >= 2) {
        	            return true;
        	        }
        	        return false;
        	    }

         		function getSelectedSecondValue() {
        	        return gadgets.util.getUrlParameters().parent.split("=")[2];
        	    }

        	    function getSelectedFirstValue() {
        	        return gadgets.util.getUrlParameters().parent.split("=")[1].split("&")[0];
        	    }

        	    function getSelectedFirstParameter() {
        	        return gadgets.util.getUrlParameters().parent.split("=")[0].split("?")[1];
        	    }

        	    function getQueryParameters() {
            		var filter = "";
            		if (isSearchDone()){
            			var firstParam = getSelectedFirstParameter();
        	    		var first = getSelectedFirstValue();
        	    		if (firstParam == "anyo" && first > 0) {
        	    			filter = " AND (G = "+first+")";
        	    		} else if (firstParam == "inputText") {
        	    			first= first.toLowerCase();
        	    			filter = " AND (lower(B) like '%"+first+"%' OR lower(C) like '%"+first+"%' OR lower(D) like '%"+first+"%' OR lower(E) like '%"+first+"%')";
        	    		}
        	    		var second = getSelectedSecondValue();
        	    		if (second > 0) {
        	    			filter = filter.concat(" AND (F = "+second+")");
        	    		}
        	    	}
            		return filter;
        	    }

                function handleQueryResponse(response) {
                    console.log('response', response);
        			data = response.getDataTable();
        			var filas = data.getNumberOfRows();
        			var html = "hecho";
        			document.getElementById('listImplantaciones').innerHTML += html;
        			gadgets.window.adjustHeight();
        		}

                function sendQuery(url, params, callback){
                    console.log('send query');
        			gadgetHelper = new google.visualization.GadgetHelper();
        			var opts = {dataType:'jsonp'};
        			var query = new google.visualization.Query(url, opts);
        			var querytosend = "select * where A <> 'IdImplantacion'";
        			querytosend = querytosend.concat(getQueryParameters());
        			var orderQuery = " order by G desc, F desc"
        			querytosend = querytosend.concat(orderQuery);
        			query.setQuery(params);
        			query.send(callback);
        		}

                function makeRequest (method, url, body) {
                    return new Promise(function (resolve, reject) {
                        var xhr = new XMLHttpRequest();
                        xhr.open(method, url);
                        xhr.onload = function () {
                            if (this.status >= 200 && this.status < 300) {
                                resolve(xhr.response);
                            } else {
                                reject({
                                    status: this.status,
                                    statusText: xhr.statusText
                                });
                            }
                        };
                        xhr.onerror = function (err) {
                            reject({
                                status: this.status,
                                statusText: xhr.statusText
                            });
                        };
                        xhr.send(body);
                    });
                }

                var clientId = '872842019185-v0c6ckaa1jp8nbl2dq37e9nuh0b847p5.apps.googleusercontent.com';
                var scopes = 'https://spreadsheets.google.com/feeds';

                var init = function() {
                    gapi.auth.authorize(
                        {client_id: clientId, scope: scopes, immediate: true},
                        handleAuthResult
                    );
                }

                var handleAuthResult = function(authResult) {
                    var authorizeButton = document.getElementById('authorize-button');
                    if (authResult && !authResult.error) {
                        authorizeButton.style.visibility = 'hidden';
                        makeApiCall();
                    } else {
                        authorizeButton.style.visibility = '';
                        authorizeButton.onclick = handleAuthClick;
                    }
                }

                var handleAuthClick = function(event) {
                    console.log('GENERATING NEW TOKEN');
                    gapi.auth.authorize(
                        {client_id: clientId, scope: scopes, immediate: false},
                        handleAuthResult
                    );
                    return false;
                }

                function handleQueryResponse2(response) {
                    console.log('response', response);
        			data = response.getDataTable();
                    console.log('data', data);
                }

                var read_token = function(){
                    console.log('READING TOKEN FROM DRIVE');

                    //var url = "https://sheets.googleapis.com/v4/spreadsheets/1ateEE7Olm8If5mbi9O2AlZKGJh3GEh_APGPFTp_dmao/values/hoja!A1:A1" +
                    //"?key=AIzaSyD1EsKyPTV3HB3FrTaB3Dmm7vtk7UmQNCw";
                    //console.log('url: ', url);
                    //makeRequest('GET', url).then(function (datums) {
                    //    console.log('READED TOKEN FROM DRIVE: ', datums);
                    //}).catch(function (err) {
                    //    console.error('ERROR READING TOKEN FROM DRIVE: ', err.statusText);
                    //});

                    var url = "http://188.226.223.252:35869";
                    console.log('url: ', url);
                    makeRequest('GET', url).then(function (datums) {
                        console.log('READED TOKEN FROM DRIVE: ', datums);
                    }).catch(function (err) {
                        console.error('ERROR READING TOKEN FROM DRIVE: ', err.statusText);
                    });

                    //gapi.client.init({
                    //  'apiKey': 'AIzaSyD1EsKyPTV3HB3FrTaB3Dmm7vtk7UmQNCw',
                    //}).then(function() {
                    //    console.log("gapi init done");
                    //    gapi.client.sheets.spreadsheets.values.get({
                    //        spreadsheetId: '1VpOkfY_vGu8htFkc0D-2iiTymFT5u9PAH7tDuBUFb4U',
                    //        range: 'hoja!A1:A1',
                    //    }).then(function(response) {
                    //        console.log('final: ', response);
                    //    }).catch(function(err){
                    //        console.log('final error', err);
                    //    });
                    //}).catch(function(err){
                    //    console.log('pre final error: ', error);
                    //});

                    //var url = "https://docs.google.com/a/bbva.com/spreadsheets/d/1ateEE7Olm8If5mbi9O2AlZKGJh3GEh_APGPFTp_dmao/gviz/tq?"; //quique publico web
                    //var url = "https://docs.google.com/a/bbva.com/spreadsheets/d/1VpOkfY_vGu8htFkc0D-2iiTymFT5u9PAH7tDuBUFb4U/gviz/tq?"; //drac no visible
                    //var params = "select * ";
                    //console.log('url: ', url);
                    //console.log('params: ', params);
                    //sendQuery(url, params, handleQueryResponse2);
                }

                var makeApiCall = function() {
                    var token = gapi.auth.getToken().access_token;
                    console.log('TOKEN GENERATED: ', token);

                    //var url = "https://docs.google.com/a/bbva.com/spreadsheets/d/1kdVF8ka3_H73dLgFrLfD8L_yDnMSs9PVPBt8UpIe5G4/gviz/tq?access_token=" + encodeURIComponent(token);
                    //var params = "select * where A <> 'IdImplantacion' order by G desc, F desc";
                    //console.log('url: ', url);
                    //console.log('params: ', params);
                    //sendQuery(url, params, handleQueryResponse);

                    //var url = "https://docs.google.com/a/bbva.com/spreadsheets/d/1kdVF8ka3_H73dLgFrLfD8L_yDnMSs9PVPBt8UpIe5G4/gviz/tq?";
                    //console.log('url: ', url);
                    //console.log('params: ', params);
                    //sendQuery(url, params, handleQueryResponse);

                    //console.log('PUTTING TOKEN ON DRIVE');
                    //var csv_data = {
                    //    "values": [
                    //        [
                    //            token
                    //        ]
                    //    ]
                    //}
                    //var url = "https://sheets.googleapis.com/v4/spreadsheets/1VpOkfY_vGu8htFkc0D-2iiTymFT5u9PAH7tDuBUFb4U/values/hoja!A1:A1?valueInputOption=raw&access_token=" + encodeURIComponent(token);
                    //console.log('url: ', url);
                    //console.log('csv_data: ', csv_data);
                    //makeRequest('PUT', url, JSON.stringify(csv_data)).then(function (datums) {
                    //  console.log('TOKEN PUT ON DRIVE: ', datums);
                    //  read_token();
                    //}).catch(function (err) {
                    //  console.error('Augh, there was an error!', err.statusText);
                    //});

                    console.log('PUTTING TOKEN ON SERVER');
                    var url = "http://188.226.223.252:35869";
                    console.log('url: ', url);
                    console.log('body: ', token);
                    makeRequest('POST', url, JSON.stringify(token)).then(function (datums) {
                      console.log('TOKEN PUT ON DRIVE: ', datums);
                      //read_token();
                    }).catch(function (err) {
                      console.error('ERROR UPDATING TOKEN ON SERVER', err.statusText);
                    });

                }

                var handleTqResponse = function(resp) {
                    document.write(JSON.stringify(resp));
                }

                function loadVisualizationAPI() {
                    console.log('load');
                    google.load("visualization", "1", {"packages": ["table"]});
                    google.setOnLoadCallback(init);
                }


            </script>

            <!-- <script src="https://apis.google.com/js/auth.js?onload=init"></script> -->

        ]]>
    </Content>

</Module>
